"use strict";(self.webpackChunkjupyterlab_ipyflow=self.webpackChunkjupyterlab_ipyflow||[]).push([[568],{568:(e,t,l)=>{l.r(t),l.d(t,{default:()=>B});var i=l(777),n=l(329),s=l(423),o=l(761),c=l.n(o);const d="waiting-cell",a="ready-cell",r="ready-making-cell",u="ready-making-input-cell",m="linked-waiting",C="linked-ready-maker",v="ipyflow-slice",h="ipyflow-slice-execute",y="ipyflow-classic-colors",g=new Event("cleanup");class x{constructor(){this.comm=null,this.notebook=null,this.session=null,this.isIpyflowCommConnected=!1,this.executionScheduledCells=[],this.selectedCells=[],this.executedCells=new Set,this.dirtyCells=new Set,this.waitingCells=new Set,this.readyCells=new Set,this.waiterLinks={},this.readyMakerLinks={},this.prevActiveCell=null,this.activeCell=null,this.cellsById={},this.orderIdxById={},this.cellPendingExecution=null,this.isReactivelyExecuting=!1,this.numAltModeExecutes=0,this.altModeExecuteCells=null,this.lastExecutionHighlights=null,this.executedReactiveReadyCells=new Set,this.newReadyCells=new Set,this.forcedReactiveCells=new Set,this.forcedCascadingReactiveCells=new Set,this.numPendingForcedReactiveCounterBumps=0,this.cellParents={},this.cellChildren={},this.settings={},this.lastCellMetadataMap=null}gatherCellMetadataAndContent(){const e={};return this.notebook.widgets.forEach(((t,l)=>{const i=t.model;e[i.id]={index:l,content:i.sharedModel.getSource(),type:i.type}})),e}requestComputeExecSchedule(){this.comm.send({type:"compute_exec_schedule",cell_metadata_by_id:this.gatherCellMetadataAndContent(),is_reactively_executing:this.isReactivelyExecuting})}executeCells(e){if(0===e.length)return;let t=0;for(const l of e)n.CodeCell.execute(l,this.session).then((()=>{var i;(null===(i=l.promptNode.textContent)||void 0===i?void 0:i.includes("[*]"))?l.setPrompt(""):this.executedCells.add(l.model.id),++t===e.length&&setTimeout((()=>this.requestComputeExecSchedule()),0)}))}toggleReactivity(){return"reactive"===this.settings.exec_mode?this.settings.exec_mode="normal":"normal"===this.settings.exec_mode&&(this.settings.exec_mode="reactive"),this.session.session.kernel.requestExecute({code:"%flow toggle-reactivity",silent:!0,store_history:!1})}bumpForcedReactiveCounter(){return this.numPendingForcedReactiveCounterBumps--,this.session.session.kernel.requestExecute({code:"%flow bump-min-forced-reactive-counter",silent:!0,store_history:!1})}computeTransitiveClosureHelper(e,t,l,i=!1,n=!1){if(!n&&e.has(t))return;i||e.add(t);const s=null==l?void 0:l[t];if(void 0===s)return;const o=e.size;s.forEach((t=>this.computeTransitiveClosureHelper(e,t,l,i))),i&&(e.size>o||!this.executedCells.has(t)||this.readyCells.has(t)||this.waitingCells.has(t))&&e.add(t)}computeTransitiveClosure(e,t=!0,l=!1){const i=new Set;for(const t of e)l?this.computeTransitiveClosureHelper(i,t,this.cellParents):this.computeTransitiveClosureHelper(i,t,this.cellChildren);if(!l)for(const e of i)this.computeTransitiveClosureHelper(i,e,this.cellParents,!0,!0);if(!t)for(const t of e)i.delete(t);return Array.from(i).filter((e=>void 0!==this.cellsById[e])).filter((e=>void 0!==this.orderIdxById[e])).sort(((e,t)=>this.orderIdxById[e]-this.orderIdxById[t])).map((e=>this.cellsById[e]))}}const f={};function p(e){delete f[e]}function w(e,t){const l={};for(const e in t)l[e]=t[e];for(const t in e)l[t]=e[t];return l}const _={id:"jupyterlab-ipyflow",requires:[s.INotebookTracker,i.ICommandPalette],autoStart:!0,activate:(e,t,l)=>{e.commands.addCommand("alt-mode-execute",{label:"Alt Mode Execute",isEnabled:()=>!0,isVisible:()=>!0,isToggled:()=>!1,execute:()=>{var l,i;const s=t.currentWidget.sessionContext;if(!s.isReady)return;e.commands.execute("notebook:enter-command-mode");const o=null!==(l=f[s.session.id])&&void 0!==l?l:{},c=o.altModeExecuteCells;if(o.altModeExecuteCells=null,null===(i=o.isIpyflowCommConnected)||void 0===i||!i)return o.executedCells.add(t.activeCell.model.id),void n.CodeCell.execute(t.activeCell,s);if(("batch"===o.settings.reactivity_mode||null===c)&&"code"===t.activeCell.model.type)if(o.numAltModeExecutes++,"incremental"===o.settings.reactivity_mode)1===o.numAltModeExecutes?o.toggleReactivity().done.then((()=>{o.executedCells.add(t.activeCell.model.id),n.CodeCell.execute(t.activeCell,s)})):(o.executedCells.add(t.activeCell.model.id),n.CodeCell.execute(t.activeCell,s));else if("batch"===o.settings.reactivity_mode){let e=null!=c?c:[t.activeCell];"normal"===o.settings.exec_mode&&null===c&&(e=o.computeTransitiveClosure([t.activeCell.model.id])),1===o.numAltModeExecutes?o.toggleReactivity().done.then((()=>o.executeCells(e))):o.executeCells(e)}else console.error(`Unknown reactivity mode: ${o.settings.reactivity_mode}`)}}),e.commands.addKeyBinding({command:"alt-mode-execute",keys:["Accel Shift Enter"],selector:".jp-Notebook"}),e.commands.addKeyBinding({command:"alt-mode-execute",keys:["Ctrl Shift Enter"],selector:".jp-Notebook"}),l.addItem({command:"alt-mode-execute",category:"execution",args:{}});const i=l=>{var i,n;const s=t.currentWidget.sessionContext;if(!s.isReady)return;const o=null!==(i=f[s.session.id])&&void 0!==i?i:{};if(null===(n=o.isIpyflowCommConnected)||void 0===n||!n)return;e.commands.execute("notebook:enter-command-mode");const c=o.computeTransitiveClosure([o.activeCell.model.id],!0,l);o.numPendingForcedReactiveCounterBumps++,"normal"===o.settings.exec_mode?o.executeCells(c):(o.altModeExecuteCells=c,e.commands.execute("alt-mode-execute"))};let o;e.commands.addCommand("execute-forward-slice",{label:"Execute Forward Slice",isEnabled:()=>!0,isVisible:()=>!0,isToggled:()=>!1,execute:()=>i(!1)}),e.commands.addKeyBinding({command:"execute-forward-slice",keys:["Accel J"],selector:".jp-Notebook"}),e.commands.addKeyBinding({command:"execute-forward-slice",keys:["Accel ArrowDown"],selector:".jp-Notebook"}),e.commands.addCommand("execute-backward-slice",{label:"Execute Backward Slice",isEnabled:()=>!0,isVisible:()=>!0,isToggled:()=>!1,execute:()=>i(!0)}),e.commands.addKeyBinding({command:"execute-backward-slice",keys:["Accel K"],selector:".jp-Notebook"}),e.commands.addKeyBinding({command:"execute-backward-slice",keys:["Accel ArrowUp"],selector:".jp-Notebook"});try{o=e.commands._commands.get("notebook:run-cell")}catch(t){o=e.commands._commands["notebook:run-cell"]}const c=o.execute,d=()=>{var e;const l=t.currentWidget.sessionContext;return l.isReady&&null!==(e=f[l.session.id])&&void 0!==e?e:{}},a=()=>{var e;const t=d(),l=t.settings;return null!==(e=t.isIpyflowCommConnected)&&void 0!==e&&e&&"reactive"===(null==l?void 0:l.exec_mode)&&"batch"===(null==l?void 0:l.reactivity_mode)};o.execute=(...t)=>{a()&&"code"===d().activeCell.model.type?e.commands.execute("notebook:enter-command-mode"):c.call(o,t)};const r=(e=!1)=>{var t;const l=d();if(null!==(t=l.isIpyflowCommConnected)&&void 0!==t&&t){let t=l.executionScheduledCells;l.executionScheduledCells=[],0===t.length&&(t=[l.activeCell.model.id]);let i=l.computeTransitiveClosure(t,!0);e&&(i=i.splice(1)),i.length>0?l.executeCells(i):l.requestComputeExecSchedule()}};s.NotebookActions.executionScheduled.connect(((e,l)=>{const i=null==t?void 0:t.currentWidget;(null==i?void 0:i.content)===l.notebook&&a()&&"code"===l.cell.model.type&&d().executionScheduledCells.push(l.cell.model.id)})),e.commands.commandExecuted.connect(((e,t)=>{var l;if("notebook:run-cell"===t.id)a()?r():null===(l=d())||void 0===l||l.requestComputeExecSchedule();else if(["notebook:run-cell-and-select-next","runmenu:run"].includes(t.id)){const e=d(),t=e.activeCell;try{e.activeCell=e.prevActiveCell,a()?r(!0):null==e||e.requestComputeExecSchedule()}finally{e.activeCell=t}}})),t.widgetAdded.connect(((e,l)=>{const i=l.sessionContext;let n=()=>p(i.session.id);const s=()=>{i.session.kernel.registerCommTarget("ipyflow-client",((e,s)=>{e.onMsg=e=>{var s;const o=e.content.data;(null===(s=o.success)||void 0===s||s)&&("unestablish"===o.type?n():"establish"===o.type&&(n(),n=M(i,t,l.content)))},n(),n=M(i,t,l.content)}))};i.ready.then((()=>{L(l.content),s(),n(),n=M(i,t,l.content),i.kernelChanged.connect(((e,o)=>{null!=o.newValue&&(L(l.content),n(),p(i.session.id),n=()=>p(i.session.id),i.ready.then((()=>{s(),n=M(i,t,l.content)})))}))}))}))}},E=e=>{if(null==e)return null;const t=e.children.item(1);return null===t?null:t.firstElementChild},R=e=>{if(null==e)return null;const t=e.children.item(2);return null===t?null:t.firstElementChild},k=(e,t,l)=>{const i=()=>{e.removeEventListener(t,l),e.removeEventListener("cleanup",i)};e.addEventListener(t,l),e.addEventListener("cleanup",i)},b=(e,t,l,i,n)=>{null!==e&&null!==t&&k(e,l,(()=>{t.firstElementChild.classList[i](n)}))},S=(e,t)=>{b(E(e),R(e),"mouseover","add",m),b(E(e),R(e),"mouseout","remove",m),b(R(e),E(e),"mouseover","add",t),b(R(e),E(e),"mouseout","remove",t)},L=e=>{e.widgets.forEach((e=>{e.node.classList.remove(y),e.node.classList.remove(d),e.node.classList.remove(r),e.node.classList.remove(a),e.node.classList.remove(u),e.node.classList.remove(v);const t=E(e.node);null!==t&&(t.firstElementChild.classList.remove(m),t.firstElementChild.classList.remove(C),t.dispatchEvent(g));const l=R(e.node);null!==l&&(l.firstElementChild.classList.remove(m),l.firstElementChild.classList.remove(C),l.dispatchEvent(g))}))},I=(e,t,l,i,n,s,o)=>{if(null===e)return;const c=()=>{for(const e of t){let t=C;o.has(e)&&(t=m);const n=i(l[e].node);if(null===n||null===n.firstElementChild)return;n.firstElementChild.classList[s](t)}};e.addEventListener(n,c),k(e,n,c)},M=(e,t,l)=>{var i,s,o,g,_,k;k=e.session.id,f[k]=new x;const b=f[e.session.id];b.activeCell=l.activeCell;const M=e.session.kernel.createComm("ipyflow","ipyflow");b.comm=M,b.notebook=l,b.session=e;let B=!1;const A=e=>{null!==e&&null!==e.model&&(e.model.isDirty?b.dirtyCells.add(e.model.id):b.dirtyCells.delete(e.model.id))},P=c().debounce((()=>{if(B)return void l.model.contentChanged.disconnect(P);const e=b.gatherCellMetadataAndContent();c().isEqual(e,b.lastCellMetadataMap)||(b.lastCellMetadataMap=e,l.widgets.forEach(A),M.send({type:"notify_content_changed",cell_metadata_by_id:e}))}),500),T=(e,t)=>{B?e.stateChanged.disconnect(T):"executionCount"===t.name&&null!==t.newValue&&(b.executedCells.add(e.id),b.dirtyCells.delete(e.id),l.widgets.forEach((t=>{t.model.id===e.id&&(t.node.classList.remove(a),t.node.classList.remove(u))})),"incremental"===b.settings.reactivity_mode&&b.requestComputeExecSchedule())};for(const e of l.widgets)e.model.stateChanged.connect(T);const H=(e,t)=>{if(B)l.model.cells.changed.disconnect(H);else if("add"===t.type)for(const e of t.newValues)null==e||e.stateChanged.connect(T);else if("remove"===t.type)for(const e of t.oldValues)null==e||e.stateChanged.disconnect(T)};l.model.cells.changed.connect(H);const q=e=>{let t=-1;l.widgets.forEach(((l,i)=>{l.model.id===e.id&&(t=i)}));const i={type:"change_active_cell",active_cell_id:e.id,active_cell_order_idx:t};M.send(i)},j=(e,t)=>{var i,n;l===e&&(B?l.activeCellChanged.disconnect(j):(q(t.model),b.prevActiveCell=b.activeCell,b.activeCell=t,null!==b.activeCell&&null!==b.activeCell.model&&"code"===b.activeCell.model.type&&(q(b.activeCell.model),b.dirtyCells.has(b.activeCell.model.id)&&(null===(n=(i=b.activeCell.model)._setDirty)||void 0===n||n.call(i,!0)),K(l))))},N=[{action:"mouseover",update:"add"},{action:"mouseout",update:"remove"}],F=(e,t,l,i)=>{var n;const{model:s,node:o}=e,c=s.id;"code"===s.type&&("classic"===(null!==(n=b.settings.color_scheme)&&void 0!==n?n:"normal")&&o.classList.add(y),l?o.classList.add(h):o.classList.remove(h),t&&!l?o.classList.add(v):o.classList.remove(v),i&&(b.waitingCells.has(c)?(o.classList.add(d),o.classList.add(a),o.classList.remove(u),S(o,m)):b.readyCells.has(c)&&(o.classList.add(u),o.classList.add(a),S(o,C)),"reactive"!==b.settings.exec_mode&&(void 0!==b.waiterLinks[c]&&N.forEach((({action:e,update:t})=>{I(E(o),b.waiterLinks[c],b.cellsById,E,e,t,b.waitingCells),I(R(o),b.waiterLinks[c],b.cellsById,E,e,t,b.waitingCells)})),void 0!==b.readyMakerLinks[c]&&(b.waitingCells.has(c)||(o.classList.add(r),o.classList.add(a)),N.forEach((({action:e,update:t})=>{I(E(o),b.readyMakerLinks[c],b.cellsById,E,e,t,b.waitingCells),I(E(o),b.readyMakerLinks[c],b.cellsById,R,e,t,b.waitingCells)}))))))},K=e=>{L(e),(e=>{b.cellsById={},b.orderIdxById={},e.widgets.forEach(((e,t)=>{b.cellsById[e.model.id]=e,b.orderIdxById[e.model.id]=t}))})(e);const t=new Set;let l=b.selectedCells;0===l.length&&(l=[b.activeCell.model.id]);for(const e of l)b.computeTransitiveClosureHelper(t,e,b.cellChildren);const i=new Set(t);for(const e of t)b.computeTransitiveClosureHelper(i,e,b.cellParents,!0,!0);for(const e of l)t.delete(e),b.computeTransitiveClosureHelper(t,e,b.cellParents);for(const l of e.widgets){const e=l.model.id;F(l,t.has(e),i.has(e),"none"!==b.lastExecutionHighlights)}},V=()=>{var e,l,i;B&&t.selectionChanged.disconnect(V);const n=null==t?void 0:t.currentWidget,s=null==n?void 0:n.sessionContext;if(null===(e=null==s?void 0:s.isReady)||void 0===e||!e)return;const o=null!==(l=f[s.session.id])&&void 0!==l?l:{};if(null===(i=o.isIpyflowCommConnected)||void 0===i||!i)return;const c=n.content;o.selectedCells=c.widgets.filter((e=>"code"===e.model.type&&c.isSelected(e))).map((e=>e.model.id)),K(c)};t.selectionChanged.connect(V);const W=c().debounce((()=>{t.currentWidget.context.save()}),200);M.onMsg=t=>{var i,s,o,c,d,a,r,u,m;const C=t.content.data;if(!B&&(null===(i=C.success)||void 0===i||i))if("establish"===C.type)b.isIpyflowCommConnected=!0,l.activeCellChanged.connect(j),l.activeCell.model.stateChanged.connect(T),q(l.activeCell.model),l.model.contentChanged.connect(P),b.requestComputeExecSchedule();else if("set_exec_mode"===C.type)b.numAltModeExecutes=0,b.settings.exec_mode=C.exec_mode;else if("compute_exec_schedule"===C.type){b.settings=C.settings;const t=null!==(c=null===(o=(s=l.model).getMetadata)||void 0===o?void 0:o.call(s,"ipyflow"))&&void 0!==c?c:{},i=null!==(d=null==t?void 0:t.cell_parents)&&void 0!==d?d:{},v=null!==(a=null==t?void 0:t.cell_children)&&void 0!==a?a:{};b.cellParents=w(C.cell_parents,i),b.cellChildren=w(C.cell_children,v),b.executedCells=new Set(C.executed_cells),null===(u=(r=l.model).setMetadata)||void 0===u||u.call(r,"ipyflow",{cell_parents:b.cellParents,cell_children:b.cellChildren}),W(),b.waitingCells=new Set(C.waiting_cells),b.readyCells=new Set(C.ready_cells),0===b.numPendingForcedReactiveCounterBumps?(b.forcedReactiveCells=new Set([...b.forcedReactiveCells,...C.forced_reactive_cells]),b.forcedCascadingReactiveCells=new Set([...b.forcedCascadingReactiveCells,...C.forced_cascading_reactive_cells])):(b.forcedReactiveCells=new Set,b.forcedCascadingReactiveCells=new Set),b.waiterLinks=C.waiter_links,b.readyMakerLinks=C.ready_maker_links,b.cellPendingExecution=null;const h=C.exec_mode;b.isReactivelyExecuting=b.isReactivelyExecuting||null!==(m=null==C?void 0:C.is_reactively_executing)&&void 0!==m&&m||"reactive"===h,b.newReadyCells="reactive"===h?new Set([...b.newReadyCells,...C.new_ready_cells]):new Set;const y=C.flow_order,g=C.exec_schedule;b.lastExecutionHighlights=C.highlights;const x=C.last_executed_cell_id;b.executedReactiveReadyCells.add(x);let f=!1;if(C.last_execution_was_error)f=!0;else if("batch"===b.settings.reactivity_mode){const e=b.computeTransitiveClosure(Array.from(b.forcedCascadingReactiveCells).filter((e=>!b.executedReactiveReadyCells.has(e)))).map((e=>e.model.id));let t;t="reactive"===h?b.computeTransitiveClosure([...b.newReadyCells,...b.forcedReactiveCells,...e].filter((e=>!b.executedReactiveReadyCells.has(e)))).filter((e=>!b.executedReactiveReadyCells.has(e.model.id))):[...b.forcedReactiveCells,...e].filter((e=>!b.executedReactiveReadyCells.has(e)&&void 0!==b.cellsById[e]&&void 0!==b.orderIdxById[e])).sort(((e,t)=>b.orderIdxById[e]-b.orderIdxById[t])).map((e=>b.cellsById[e])),0===t.length?f=!0:(b.isReactivelyExecuting=!0,b.executedReactiveReadyCells=new Set([...b.executedReactiveReadyCells,...t.map((e=>e.model.id))]),b.executeCells(t))}else if("incremental"===b.settings.reactivity_mode){let t=!1;for(const e of l.widgets){if(!t&&(t=e.model.id===x,"in_order"===y||"strict"===g))continue;if("code"!==e.model.type||b.executedReactiveReadyCells.has(e.model.id))continue;if(!(b.forcedReactiveCells.has(e.model.id)||b.newReadyCells.has(e.model.id)&&"reactive"===h))continue;const l=e;if(null===b.cellPendingExecution){if(b.cellPendingExecution=l,"in_order"===y||"strict"===g)break}else null==l.model.executionCount||l.model.executionCount<b.cellPendingExecution.model.executionCount&&(b.cellPendingExecution=l)}null===b.cellPendingExecution?f=!0:(b.isReactivelyExecuting=!0,b.executedCells.add(b.cellPendingExecution.model.id),n.CodeCell.execute(b.cellPendingExecution,e))}f&&(b.isReactivelyExecuting&&("reactive"===b.lastExecutionHighlights&&(b.readyCells=b.executedReactiveReadyCells),M.send({type:"reactivity_cleanup"})),b.numAltModeExecutes>0&&0==--b.numAltModeExecutes&&b.toggleReactivity(),b.numPendingForcedReactiveCounterBumps>0&&b.bumpForcedReactiveCounter(),b.forcedReactiveCells=new Set,b.forcedCascadingReactiveCells=new Set,b.newReadyCells=new Set,b.executedReactiveReadyCells=new Set,b.isReactivelyExecuting=!1,K(l))}};const D=null!==(o=null===(s=(i=l.model).getMetadata)||void 0===s?void 0:s.call(i,"ipyflow"))&&void 0!==o?o:{};return M.open({interface:"jupyterlab",cell_metadata_by_id:b.gatherCellMetadataAndContent(),cell_parents:null!==(g=null==D?void 0:D.cell_parents)&&void 0!==g?g:{},cell_children:null!==(_=null==D?void 0:D.cell_children)&&void 0!==_?_:{}}),()=>{M.dispose(),B=!0,b.isIpyflowCommConnected=!1,p(e.session.id)}},B=_}}]);