import{r as c,u as B,j as e,B as $,N as I,E as H,h as z,M as Q,d as V,k as W,a6 as G,n as O,t as Y,R as E,a7 as X,_ as N,o as Z,a9 as q,U as J,Q as ee,V as te,S as ne,W as se,X as ae,Y as oe,aa as re}from"./__uno-a5464b02.js";import{u as ie,a as le,b as ce,c as de,C as pe,I as R,d as ue,e as xe,S as he,f as me,L as A,g as P}from"./useSubmitHandler-c6ae9d65.js";import"./index-fa95a8b3.js";var D=(a=>(a.LLM_CHAT="llm_chat",a))(D||{});const y=15;function fe({scrollRef:a,inputRef:l,setAutoScroll:i,useChatStore:x,session:t}){const o=x(),{job:r}=t.serving??{},[d]=B(),h=!1,[,p]=c.useState(!0),m=c.useMemo(()=>t.mask.hideContext?[]:(t.mask.context??[])?.slice(),[t.mask.context,t.mask.hideContext]),u=c.useMemo(()=>m.concat(t.messages).concat([]),[m,h,t.messages]),[f,w]=c.useState(Math.max(0,u.length-y));function j(s){s=Math.min(u.length-y,s),s=Math.max(0,s),w(s)}const C=c.useMemo(()=>{const s=Math.min(f+3*y,u.length);return u.slice(f,s)},[f,u]),_=s=>{c.startTransition(()=>{const v=s.scrollTop+s.clientHeight,M=s.clientHeight,L=s.scrollTop<=M,k=v>=s.scrollHeight-M,F=v>=s.scrollHeight-10,K=f-y,U=f+y;L&&!k?j(K):k&&j(U),p(F)})},[g,T]=c.useState(!1),[b,n]=c.useState(!1),S=ue(async()=>{await o.checkSessionApiById(t.id)&&(S(),T(!0))},1e3);return xe({leftTime:30*1e3,onEnd:()=>{g||n(!0),S()}}),!t||!r?e.jsx(I,{type:"empty"}):e.jsxs("div",{className:"chat rounded-4px border-1 border-[#cfd7e6] h-full overflow-hidden flex flex-col pb-15px bg-white",children:[e.jsx("div",{className:"chat-title flex lh-none h-40px bg-[#eef1f6] px-10px items-center",children:e.jsx(H,{disabled:!t?.serving,icon:"setting",styleas:["menuoption","nopadding","iconnormal",t?.serving?void 0:"icondisable"],onClick:()=>o.onSessionEditParamsShow(r.id)})}),e.jsxs("div",{className:"chat-body flex-1 overflow-auto overflow-x-hidden p-10px pb-0px relative overscroll-none flex gap-20px flex-col min-w-0 h-full bg-white",ref:a,onScroll:s=>_(s.currentTarget),onMouseDown:()=>l.current?.blur(),onTouchStart:()=>{l.current?.blur(),i(!1)},children:[!g&&!b&&e.jsx(I,{children:d("ft.online_eval.api.loading")}),!g&&b&&e.jsx(I,{type:"center",children:e.jsxs(z,{$style:{color:"rgba(2,16,43,0.20)"},children:[d("ft.online_eval.api.failed")," "]})}),g&&C.map(s=>{const v=s.role==="user";return e.jsx(c.Fragment,{children:e.jsx("div",{className:`${v?"chat-message-user ":"chat-message"} `,children:e.jsx("div",{className:`chat-message-container  rounded-4px border-1 px-10px py-4px break-words text-wrap inline-block ${v?"bg-white":"bg-[#EBF1FF]"}`,children:e.jsx("div",{className:"chat-message-item",children:e.jsx("div",{children:s.content})})})})},s.id)})]})]})}function ge({useChatStore:a}){const l=a(),[i]=B(),[x,t]=c.useReducer(r=>r+1,0),o=l.getSessionById(l?.editingSessionId);return o?e.jsxs(Q,{isOpen:!!l.editingSessionId,onClose:()=>l.onSessionEditParamsHide(),closeable:!0,animate:!0,autoFocus:!0,children:[e.jsx(V,{children:o?.serving?.job?.modelName}),e.jsx(W,{$style:{paddingBottom:"20px"},children:e.jsxs("div",{className:"py-20px border-t-1px border-b-1px",children:[e.jsxs("div",{className:" mb-20px flex justify-between",children:[i("ft.online_eval.parameter.title"),e.jsx(H,{kind:"secondary",icon:"reset",onClick:()=>{l.onSessionEditParamsReset(o.id),t()},children:i("ft.online_eval.parameter.reset")})]}),e.jsx("div",{className:"gap-20px",children:o?.serving?.apiSpec?.components?.map(({componentValueSpecFloat:r,componentValueSpecInt:d,...h})=>{const p=r??d,m=o.params?.[h.name]??p?.defaultVal??0;return p?e.jsxs("div",{className:"grid grid-cols-[100px_1fr_40px]",children:[e.jsx("p",{className:"pt-5px break-words",children:h.name}),e.jsx(he,{overrides:{ThumbValue:{style:{backgroundColor:"#2B65D9",width:"50px !important",height:"32px !important",position:"relative",top:"-30px",textAlign:"center",display:"flex",justifyContent:"center",alignItems:"center",...G("50px"),...O("0px","12px","0px","12px")}},InnerThumb:{style:{backgroundColor:"#2B65D9",width:"1px"}},Thumb:{style:{width:"16px",height:"16px",borderColor:"#2B65D9",backgroundColor:"#fff",borderWidth:"2px"}}},initialState:{value:[m]},min:p?.min??void 0,max:p?.max??void 0,step:p?.step??void 0,onFinalChange:({value:u})=>{l.onSessionEditParams(o.id,{[h.name]:u[0]})}}),e.jsx("p",{className:"pt-5px break-words",children:m})]},[h.name,x].join("-")):null})})]})})]}):null}function Se({useStore:a}){const l=a(),i=c.useRef(null),x=ie(),[t,o]=c.useState(""),{submitKey:r,shouldSubmit:d}=le(),{scrollDomToBottom:h,setAutoScroll:p,scrollRefs:m}=x,u={inputRef:i,...x,userInput:t,setUserInput:o},[f]=B(),[w,j]=c.useState(2),C=ce();de(()=>{const n=i.current?me(i.current):1,S=Math.min(5,Math.max(1,n));j(S)},[t],{wait:100,leading:!0,trailing:!0});const _=n=>{o(n)},g=n=>{n.trim()!==""&&(o(""),i.current?.focus(),p(!0),l.onUserInput(R.llm_chat,n),localStorage.setItem(A,t))},T=n=>{if(n.key==="ArrowUp"&&t.length<=0&&!(n.metaKey||n.altKey||n.ctrlKey)){o(localStorage.getItem(A)??""),n.preventDefault();return}d(n)&&(g(t),n.preventDefault())};function b(){h()}return e.jsxs("div",{className:"chat-group flex flex-col overflow-hidden",children:[e.jsx("div",{className:"flex overflow-x-auto gap-20px mb-10px text-nowrap flex-nowrap pb-10px mx-auto",children:e.jsx(pe,{defaultConstraints:[1e3,500],children:l.sessions.filter(n=>n.show&&n.serving?.type===R.llm_chat).map((n,S)=>n.id?e.jsx(fe,{...u,useChatStore:a,session:n,scrollRef:s=>{m.current[S]=s}},n.id):null)})}),e.jsxs("div",{className:"chat-input-panel-inner w-full border-1 flex flex-1 py-6px px-12px items-end rounded-4px bg-white",children:[e.jsx("textarea",{ref:i,className:"chat-input w-full h-full resize-none lh-32px outline-none",placeholder:f("ft.online_eval.enter.placeholder",[r]),onInput:n=>_(n.currentTarget.value),value:t,onKeyDown:T,onFocus:b,onClick:b,rows:w,style:{fontSize:C.fontSize}}),e.jsx("div",{className:"flex-shrink-0 lh-none",children:e.jsx($,{onClick:()=>g(t),children:"Enter"})})]}),e.jsx(ge,{useChatStore:a})]})}const be=async()=>{const{data:a}=await Z.get("/api/spec");return a};function ve(){const a=Y("spec",be),l=P(),[i,x]=E.useState(),[t,o]=E.useState();return c.useEffect(()=>{if(!a.data)return;const r=a.data.apis[0];l.newOrUpdateSession({job:{id:"client"},type:r?.inference_type,exposedLink:{link:"",type:"WEB_HANDLER",name:"llm_chat"},apiSpec:a.data.apis[0]}),x(a.data),o(a.data.apis[0])},[a.data]),e.jsxs("div",{children:[(i?.apis?.length??0)>1&&e.jsx(X,{options:N.map(i?.apis,r=>({id:r.inference_type,label:r.inference_type})),value:[{id:t?.inference_type,label:t?.inference_type}],onChange:({option:r})=>{if(!r||!i?.apis)return;const d=N.find(i.apis,{inference_type:r.id});d&&o(d)}}),t?.inference_type===D.LLM_CHAT&&e.jsx(Se,{useStore:P})]})}q();function ye(){return e.jsx(J,{client:new ee,children:e.jsx(te,{value:new ne,children:e.jsx(se,{theme:ae,children:e.jsx(oe,{locale:{},children:e.jsx(ve,{})})})})})}const je=re.createRoot(document.getElementById("root"));je.render(e.jsx(ye,{}));
