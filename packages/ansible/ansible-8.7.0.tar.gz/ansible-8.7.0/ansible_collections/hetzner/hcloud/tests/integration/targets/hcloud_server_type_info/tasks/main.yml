# Copyright: (c) 2019, Hetzner Cloud GmbH <info@hetzner-cloud.de>
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)
---
- name: test gather hcloud server type infos
  hcloud_server_type_info:
  register: hcloud_server_types
- name: verify test gather hcloud server type infos
  assert:
    that:
      - hcloud_server_types.hcloud_server_type_info| list | count > 2

- name: test gather hcloud server type infos in check mode
  hcloud_server_type_info:
  check_mode: true
  register: hcloud_server_types

- name: verify test gather hcloud server type infos in check mode
  assert:
    that:
      - hcloud_server_types.hcloud_server_type_info| list | count > 2

- name: test gather hcloud server type infos with name
  hcloud_server_type_info:
    name: "{{hcloud_server_type_name}}"
  register: hcloud_server_types
- name: verify test gather hcloud server type with name
  assert:
    that:
      - hcloud_server_types.hcloud_server_type_info|selectattr('name','equalto','{{ hcloud_server_type_name }}') | list | count == 1
      - hcloud_server_types.hcloud_server_type_info[0].deprecation is none # fails if cx11 is ever deprecated

- name: test gather hcloud server type infos with correct id
  hcloud_server_type_info:
    id: "{{hcloud_server_type_id}}"
  register: hcloud_server_types
- name: verify test gather hcloud server type with correct id
  assert:
    that:
      - hcloud_server_types.hcloud_server_type_info|selectattr('name','equalto','{{ hcloud_server_type_name }}') | list | count == 1

- name: test gather hcloud server type infos for deprecated server type
  hcloud_server_type_info:
    id: "{{hcloud_server_type_id_deprecated}}"
  register: hcloud_server_types

- name: verify test gather hcloud server type with deprecated field
  assert:
    that:
      - hcloud_server_types.hcloud_server_type_info[0].deprecation is not none
      - hcloud_server_types.hcloud_server_type_info[0].deprecation.announced == '2021-11-09T09:00:00+00:00'
      - hcloud_server_types.hcloud_server_type_info[0].deprecation.unavailable_after == '2021-12-01T00:00:00+00:00'
