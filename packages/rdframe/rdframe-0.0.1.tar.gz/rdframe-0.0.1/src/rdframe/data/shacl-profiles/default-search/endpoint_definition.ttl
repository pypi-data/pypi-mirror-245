PREFIX dcat: <http://www.w3.org/ns/dcat#>
PREFIX dcterms: <http://purl.org/dc/terms/>
PREFIX endpoint: <https://prez.dev/endpoint/system/>
PREFIX ont: <https://prez.dev/ont/>
PREFIX prez: <https://prez.dev/>
PREFIX sh: <http://www.w3.org/ns/shacl#>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
PREFIX shext: <http://example.com/shacl-extension#>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>


endpoint:search a ont:ListingEndpoint ;
    ont:endpointTemplate "/search" ;
    sh:targetClass prez:SearchResult ;
    shext:limit 20 ;
    shext:offset 0 ;
    sh:rule [ sh:subject "?hashID" ;
              sh:predicate <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> ;
                sh:object prez:SearchResult ] ;
    sh:rule [ sh:subject "?hashID" ;
              sh:predicate prez:searchResultWeight ;
                sh:object "?weight" ] ;
    sh:rule [ sh:subject "?hashID" ;
              sh:predicate prez:searchResultPredicate ;
                sh:object "?predicate" ] ;
    sh:rule [ sh:subject "?hashID" ;
              sh:predicate prez:searchResultMatch ;
                sh:object "?match" ] ;
    sh:rule [ sh:subject "?hashID" ;
              sh:predicate prez:searchResultURI ;
                sh:object "?search_result_uri" ] ;
    sh:target [ sh:select """SELECT ?search_result_uri ?predicate ?match ?weight (URI(CONCAT("urn:hash:", SHA256(CONCAT(STR(?search_result_uri), STR(?predicate), STR(?match), STR(?weight))))) AS ?hashID)
    WHERE {
        SELECT ?search_result_uri ?predicate ?match (SUM(?w) AS ?weight)
        WHERE
        {
          ?search_result_uri ?predicate ?match .
            VALUES ?predicate { $predicates }
            {
                ?search_result_uri ?predicate ?match .
                BIND (100 AS ?w)
                FILTER (LCASE(?match) = "$term")
            }
          UNION
            {
                ?search_result_uri ?predicate ?match .
                BIND (20 AS ?w)
                FILTER (REGEX(?match, "^$term", "i"))
            }
          UNION
            {
                ?search_result_uri ?predicate ?match .
                BIND (10 AS ?w)
                FILTER (REGEX(?match, "$term", "i"))
            }
        }
        GROUP BY ?search_result_uri ?predicate ?match
    }
        ORDER BY DESC(?weight)
             """ ] ;
.

<urn:local:property:1> a rdf:Property .