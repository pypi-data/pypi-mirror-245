"use strict";(self.webpackChunk_atoti_jupyterlab_extension=self.webpackChunk_atoti_jupyterlab_extension||[]).push([[2275],{52275:(e,t,l)=>{l.r(t),l.d(t,{default:()=>B});var n=l(93388),o=l(77026),r=l(66029),i=l(34420),a=l(92010),s=l(89198),c=l(93481),d=l(40061),u=l(8261);function p({captionForTotals:e,cube:t,mapping:l,tuple:n,style:o}){return n.map((n=>(0,u.h)({captionForTotals:e,cube:t,mapping:l,member:n,style:o}))).join(" ")}var m=l(81292);const h=e=>{const t=(0,r.useMemo)((()=>r.Children.toArray(e.children).reduce(((t,l,n)=>{const o=Math.floor(n/e.numberOfColumns),r=t[o]??[];return t[o]=[...r,l],t}),[])),[e.children,e.numberOfColumns]);return(0,n.tZ)("div",{style:e.containerStyle,css:{paddingBottom:2,paddingRight:2,width:"100%",height:"100%"},children:(0,n.tZ)("div",{css:{width:"100%",height:"100%",overflow:"auto"},children:(0,n.tZ)("table",{css:m.css`
            border-spacing: 20px 10px;
            border-collapse: separate !important;
            width: 100%;
          `,children:(0,n.tZ)("tbody",{children:t.map(((e,t)=>(0,n.tZ)("tr",{children:e.map(((e,t)=>(0,n.tZ)("td",{children:e},t)))},t)))})})})})};var g=l(89038),f=l(3920),y=l(48540),C=l(12274),b=l(85039),v=l(15169);const x=e=>{const t=(0,C.Fg)(),l=(0,b.T)(),o={color:t.textColor,paddingLeft:e.horizontalPadding,paddingRight:e.horizontalPadding,height:25},i={...o,border:"1px solid transparent",background:"transparent",":hover":{border:`1px solid  ${t.primaryColor}`,borderRadius:3},":focus":{outlineColor:t.primaryColor}},[a,s]=(0,r.useState)(e.title);return(0,r.useEffect)((()=>{s(e.title)}),[e.title]),l?(0,n.tZ)("div",{css:o,children:a}):(0,n.tZ)(v.AutoSizedInput,{isStrictlySized:!1,inputCss:i,value:a||"",onChange:s,onBlur:()=>{e.onTitleChange?.(a)}})},S=(e,t)=>isNaN(e)?"N/A":`${e>0?"+":""}${t}`,w=(e,t)=>isNaN(e)||0===e?t.textColor:e>0?t.successColor:t.errorColor,M=e=>{const t=(0,C.Fg)(),{formatMessage:l}=(0,c.useIntl)(),{onTitleChange:a,title:s,isTime:d,tuple:u,onSelect:p,isSelected:m,differenceCell:h,style:g}=e,b=Number(e.differenceCell?.value),v=e.differenceCell?.formattedValue,M=Number(e.referenceCell?.value),I=m?`${t.selectionOverlayColor}`:"none",T=(0,r.useMemo)((()=>{const e=u.find((({dimensionName:e})=>"Measures"===e))?.namePath[0];return e?g?.measures?.[e]:void 0}),[u,g?.measures]),Z=e.comparedCell&&(0,o.isNumber)(e.comparedCell.value)&&e.comparedCell.value<0,[[O,N],[k,A]]=(0,r.useMemo)((()=>[e.referenceCell,e.comparedCell].map((e=>[(0,f.m)({value:Number(e?.value),valueFormattedByActivePivot:e?.formattedValue??"N/A",measureStyle:T}),(0,y.d)({measureStyle:T,value:e?.value})]))),[T,e.referenceCell,e.comparedCell]);return(0,n.BX)("div",{style:{background:I,height:83,display:"flex",alignItems:"flex-end",padding:"0px 2px"},onMouseDown:e=>{(0===e.button||!m&&2===e.button)&&p({cell:h,tuple:u,isSelected:m})},children:[(0,n.tZ)("span",{style:{borderLeft:`3px solid ${t.primaryColor}`,height:75}}),(0,n.BX)("div",{style:{display:"flex",paddingLeft:5,flexDirection:"column"},children:[(0,n.tZ)(x,{title:s,onTitleChange:e=>{const t=(0,i.getTupleKey)(u);a?.({tupleKey:t,title:e})},horizontalPadding:"2px"}),(0,n.BX)("div",{style:{display:"flex"},children:[(0,n.BX)("div",{style:{display:"flex",flexDirection:"column",justifyContent:"space-between",whiteSpace:"nowrap",paddingLeft:2},children:[(0,n.tZ)("span",{style:{fontWeight:600,fontSize:20,lineHeight:1.5,color:A.backgroundColor||(Z?t.errorColor:void 0)},children:k}),d?l({id:"aui.plugins.widget.kpi.on"},{value:e.comparedMemberCaption}):e.comparedMemberCaption]}),(0,n.tZ)("span",{style:{margin:"8px 10px 3px",borderLeft:`1px solid ${t.grayScale[4]}`}}),(0,n.BX)("div",{style:{paddingTop:3,display:"flex",justifyContent:"space-around",flexDirection:"column",whiteSpace:"nowrap"},children:[(0,n.tZ)("span",{style:{color:w(b,t),fontWeight:500},children:S(b,g?.isDifferenceInPercentage?(0,f.m)({value:b/Math.abs(M),valueFormattedByActivePivot:"N/A",measureStyle:{numberFormat:"percentage",numberOfDecimals:2}}):(0,f.m)({value:b,valueFormattedByActivePivot:v??"N/A",measureStyle:T}))}),(0,n.tZ)("span",{style:{fontSize:9,color:N.backgroundColor},children:l({id:"aui.plugins.widget.kpi.vs"},{value:O})}),d?l({id:"aui.plugins.widget.kpi.on"},{value:e.referenceMemberCaption}):e.referenceMemberCaption]})]})]})]})},I=(e,t)=>{const l=[];return e&&t&&l.push({tuple:t,value:e.value}),{axes:[],cells:l}};var T=l(41038);function Z(e,t){const{cells:l,numberOfColumns:n,numberOfRows:o}=(0,r.useMemo)((()=>{let t,l;for(let n=0;n<e.axes.length;n++){const o=e.axes[n];if(o.id===i.axisIds.columns?l=o:o.id===i.axisIds.rows&&(t=o),void 0!==t&&void 0!==l)break}const n=l?(0,i.getAxisLength)(l):1,o=t?(0,i.getAxisLength)(t):1,r=new Array(n*o).fill(null);return e.cells.forEach((e=>{r[e.ordinal]=e})),{numberOfColumns:n,numberOfRows:o,cells:r}}),[e]),a=(0,r.useMemo)((()=>(0,i.getHierarchyIndicesInCellSet)(e,{axisNames:["ROWS","COLUMNS"]})),[e]);return{cells:l,numberOfColumns:n,numberOfRows:o,cube:(0,r.useMemo)((()=>{const l=e.cube;return(0,T.s)(t,l)}),[e,t]),hierarchyIndicesInCellSet:a}}const O=["referenceCell","comparedCell","differenceCell"],N=e=>{const{formatMessage:t}=(0,c.useIntl)(),{cube:l,hierarchyIndicesInCellSet:a,numberOfColumns:m,numberOfRows:f}=Z(e.data,e.dataModel),y=e.data.axes.find((({id:e})=>e===i.axisIds.pages));if(!y)throw new Error("A comparison was defined in the KPI widget state, but no corresponding data was found (no PAGES axis in the cellset).");if((0,s.K)(e.comparison)&&3!==y.positions.length)throw new g.V;const C=(0,d.F)(y.hierarchies[0].dimension,l),b=t({id:"aui.total"}),[v,x]=(0,r.useMemo)((()=>{const{dimension:t,hierarchy:n}=y.hierarchies[0];return y.positions.map((([o])=>(0,u.h)({captionForTotals:b,cube:l,mapping:e.mapping,member:{dimensionName:t,hierarchyName:n,...o},style:e.style})))}),[b,l,y,e.mapping,e.style]),S=(0,r.useMemo)((()=>{const t={},n=m*f;return e.data.cells.forEach((o=>{const r=Math.floor(o.ordinal%n/m),s=o.ordinal%m,c=(0,i.getTuple)({columnIndex:s,rowIndex:r,hierarchyIndicesInCellSet:a,data:e.data});if(c){const r=(0,i.getTupleKey)(c),a=t[r]?.title||e.titles?.[r]||p({captionForTotals:b,cube:l,mapping:e.mapping,tuple:c,style:e.style}),s=Math.floor(o.ordinal/n),d=O[s];t[r]={...t[r],[d]:o,title:a,tuple:c}}}),{}),t}),[b,l,a,m,f,e.data,e.titles,e.mapping,e.style]),{titles:w,onTitlesChange:T,onSelectionChange:N}=e,k=({tupleKey:e,title:t})=>{T?.({...w,[e]:t})},[A,K]=(0,r.useState)({axes:[],cells:[]}),E=A.cells?.[0]?(0,i.getTupleKey)(A.cells[0].tuple):void 0,F=({cell:e,tuple:t,isSelected:l})=>{K(l?{axes:[],cells:[]}:I(e,t))};(0,r.useEffect)((()=>{N?.(A)}),[A,N]);const L=(0,o.map)(S,(({referenceCell:t,comparedCell:l,differenceCell:o,title:r,tuple:i},a)=>(0,n.tZ)(M,{comparedCell:l,comparedMemberCaption:x,isTime:"TIME"===C.type,differenceCell:o,title:r,onTitleChange:k,referenceCell:t,referenceMemberCaption:v,tuple:i,onSelect:F,isSelected:E===a,style:e.style},a)));return(0,n.tZ)(h,{numberOfColumns:m,containerStyle:e.containerStyle,children:L})};var k=l(54822),A=l(87307);const K=e=>{const t=(0,C.Fg)(),{cell:l,tuple:o,tupleKey:i,onTitleChange:a,title:s,isSelected:c,onSelect:d,style:u}=e,p=(0,k.E)(l?.properties),h=c&&p.backgroundColor?(0,A.$)(p.backgroundColor,t.selectionOverlayColor,.2):c?t.selectionOverlayColor:p.backgroundColor??"none",[g,b]=(0,r.useMemo)((()=>{const e=o.find((({dimensionName:e})=>"Measures"===e))?.namePath[0],t=e?u?.measures?.[e]:void 0;return[(0,f.m)({value:Number(l?.value),valueFormattedByActivePivot:l?.formattedValue??"N/A",measureStyle:t}),(0,y.d)({measureStyle:t,value:l?.value})]}),[o,u?.measures,l]);return(0,n.BX)("div",{css:m.css`
        padding-left: 6px;
        border-left: 3px solid ${t.primaryColor};
        white-space: nowrap;
      `,children:[(0,n.tZ)(x,{title:s,onTitleChange:e=>{a({title:e,tupleKey:i})},horizontalPadding:2}),(0,n.tZ)("div",{onMouseDown:e=>{(0===e.button||!c&&2===e.button)&&d({cell:l,tuple:o,isSelected:c})},css:{background:h,color:b.backgroundColor??p.color,fontSize:30,height:50,display:"flex",alignItems:"center",paddingLeft:2},children:g})]})},E=e=>{const{formatMessage:t}=(0,c.useIntl)(),{cells:l,numberOfColumns:o,cube:a}=Z(e.data,e.dataModel),s=(0,r.useMemo)((()=>(0,i.getHierarchyIndicesInCellSet)(e.data)),[e.data]),{titles:d,onTitlesChange:u,onSelectionChange:m}=e,g=({tupleKey:e,title:t})=>{u?.({...d,[e]:t})},[f,y]=(0,r.useState)({axes:[],cells:[]}),C=f.cells?.[0]?(0,i.getTupleKey)(f.cells[0].tuple):void 0,b=({cell:e,tuple:t,isSelected:l})=>{y(l?{axes:[],cells:[]}:I(e,t))},v=t({id:"aui.total"}),x=(0,r.useMemo)((()=>{const t=[];return l.forEach(((l,n)=>{const r=Math.floor(n/o),c=n%o,u=(0,i.getTuple)({columnIndex:c,data:e.data,rowIndex:r,hierarchyIndicesInCellSet:s});if(u){const n=(0,i.getTupleKey)(u),o=a?p({captionForTotals:v,cube:a,mapping:e.mapping,tuple:u,style:e.style}):"",r=d?.[n]||o;t.push({cell:l,tuple:u,tupleKey:n,title:r})}})),t}),[l,a,e.data,s,o,d,v,e.mapping,e.style]);(0,r.useEffect)((()=>{m?.(f)}),[f,m]);const S=x.map((({cell:t,tuple:l,tupleKey:o,title:r},i)=>(0,n.tZ)(K,{cell:t,cellIndex:i,tuple:l,tupleKey:o,title:r,onTitleChange:g,onSelect:b,isSelected:C===o,style:e.style},i)));return(0,n.tZ)(h,{numberOfColumns:o,containerStyle:e.containerStyle,children:S})},F=e=>{const{comparison:t,...l}=e;return(0,s.K)(e.comparison)?(0,n.tZ)(N,{comparison:t,...l}):(0,n.tZ)(E,{...l})};var L=l(99856),P=l(17072);const B=(0,r.memo)((e=>{(0,v.useCallOnLoadedAfterFirstProperRender)(e);const{queryResult:t,widgetState:l,onChange:c,onSelectionChange:d}=e,u=t.data,p=l.serverKey,m=(0,a.k)(p),h=l.titles,g=(0,r.useCallback)((e=>c((0,o.isEmpty)(e)?(0,o.omit)(l,"titles"):{...l,titles:e})),[l,c]);if(!t.isLoading&&t.error){if((0,i.isQueryErrorOfType)(t.error,"QueryTimeoutException"))throw new i.QueryTimeoutError(t.error);throw new i.MdxError(t.error)}if((0,L.isMappingEmpty)(l.mapping))return(0,n.tZ)(P.A,{style:e.style});const f=(t&&(0,s.K)(l.comparison)?t.isLoading||!t.data?.axes.some((({id:e})=>e===i.axisIds.pages)):t.isLoading)||!u||!m,y=0===u?.cells.length;return(0,n.tZ)(L.WidgetLoadingOverlay,{isLoading:f,children:!f&&u&&!y&&m?(0,n.tZ)(F,{data:u,dataModel:m,titles:h,onTitlesChange:g,comparison:l.comparison,containerStyle:e.style,onSelectionChange:d,style:l.style,mapping:l.mapping}):(0,n.tZ)(P.A,{style:e.style,noData:y})})}))}}]);